<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Code Viewer · Module</title>

        <!-- Bootstrap 5 -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet">

        <!-- Font Awesome -->
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            rel="stylesheet">

        <!-- Prism themes -->
        <link id="prism-dark"
            href="https://cdn.jsdelivr.net/gh/PrismJS/prism-themes/themes/prism-nord.css"
            rel="stylesheet" />
        <link id="prism-light"
            href="https://cdn.jsdelivr.net/gh/PrismJS/prism-themes/themes/prism-ghcolors.css"
            rel="stylesheet" />

        <!-- Prism line numbers -->
        <link
            href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.css"
            rel="stylesheet" />

        <style>
    :root{ --bg-dark:#071029; --muted-dark:#9fb3d9; --primary:#7c3aed; --accent:#ec4899; }
    html,body{height:100%}
    body{font-family:Inter,system-ui,'Segoe UI',Roboto,Arial;margin:0;padding:20px;background:linear-gradient(180deg,#041224 0%,var(--bg-dark) 40%);color:#e6f0fa;transition:background .18s,color .18s}
    body.viewer-light{background:#f3f7fb;color:#0b2b3a}

    .viewer{max-width:1200px;margin:18px auto;border-radius:14px;overflow:hidden;box-shadow:0 30px 70px rgba(3,8,20,0.6);border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
    body.viewer-light .viewer{box-shadow:0 12px 30px rgba(16,24,40,0.06);border:1px solid rgba(16,24,32,0.06);background:#fff}

    .viewer-top{display:flex;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(90deg,rgba(6,18,30,0.6),rgba(3,12,20,0.6));border-bottom:1px solid rgba(255,255,255,0.02)}
    body.viewer-light .viewer-top{background:#fff;border-bottom:1px solid rgba(16,24,32,0.04)}
    .top-left{display:flex;align-items:center;gap:12px;min-width:0}
    .top-center{margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
    .top-right{display:flex;gap:10px;align-items:center;margin-left:auto}

    .filename{font-weight:800;font-size:1.05rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px}
    .subtle{color:var(--muted-dark);font-weight:600}

    .btn-back { width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--muted-dark); }
    body.viewer-light .btn-back{ color:#0b2b3a; border:1px solid rgba(16,24,32,0.06) }

    .tool-btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);color:var(--muted-dark);font-weight:700;cursor:pointer;transition:transform .12s,box-shadow .12s}
    body.viewer-light .tool-btn{background:rgba(2,6,23,0.02);color:#3b5566;border:1px solid rgba(16,24,32,0.04)}
    .tool-btn:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,0.06);color:#fff}
    .tool-btn.primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;border:none;box-shadow:0 10px 24px rgba(124,58,237,0.12)}

    .viewer-editor{padding:16px;background:linear-gradient(180deg, rgba(2,18,28,0.6), rgba(0,10,15,0.6))}
    body.viewer-light .viewer-editor{background:#f7fbff}
    pre[class*="language-"]{margin:0;padding:18px !important;border-radius:10px;overflow:auto;background:#001826 !important;font-family:"Fira Code","JetBrains Mono",monospace;font-size:15px;line-height:1.55;border:1px solid rgba(255,255,255,0.02);max-height:72vh}
    body.viewer-light pre[class*="language-"]{background:#fbfcfe !important;color:#072033;border:1px solid rgba(16,24,32,0.04)}

    /* Make sure line numbers capture pointer events */
    pre.line-numbers { position: relative !important; display: block !important; padding-left: 3.6em !important; }
    .line-numbers-rows { position: absolute; top: 0; left: 0; width: 3.2em; pointer-events: auto !important; user-select: none; border-right:1px solid rgba(255,255,255,0.02); }
    .line-numbers-rows>span { display: block; pointer-events: auto !important; }
    .line-numbers-rows>span:before { pointer-events: auto !important; color: rgba(255,255,255,0.12) !important; cursor:pointer; font-size:12px; padding:0 8px 0 10px; }

    body.viewer-light .line-numbers-rows>span:before{color:rgba(6,10,14,0.45) !important}
    body.viewer-light .line-numbers-rows{border-right:1px solid rgba(16,24,32,0.04)}

    .ln-copy-btn{position:absolute;z-index:9998;display:flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;background:rgba(3,8,16,0.75);color:white;font-size:12px;padding:0;border:none;cursor:pointer;opacity:0;transform:translateX(-6px);transition:opacity .12s,transform .12s}
    body.viewer-light .ln-copy-btn{background:rgba(12,16,20,0.9)}
    .ln-copy-btn.show{opacity:1;transform:translateX(0)}

    .ln-tooltip{position:absolute;background:rgba(2,16,26,0.95);color:#e6f6fa;padding:6px 8px;border-radius:6px;font-size:12px;transform:translateY(-130%);z-index:9999;opacity:0;transition:opacity .12s,transform .12s;pointer-events:none}
    .ln-tooltip.show{opacity:1;transform:translateY(-110%)}

    .ln-flash{position:absolute;z-index:9997;pointer-events:none;border-radius:6px;opacity:.98}

    .selected-overlay{position:absolute !important;left:0;right:0;background:linear-gradient(90deg, rgba(124,58,237,0.06), rgba(236,72,153,0.02));border-radius:6px;pointer-events:none;z-index:9996}

    .viewer-status{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;font-size:0.92rem;color:var(--muted-dark);border-top:1px solid rgba(255,255,255,0.02)}
    body.viewer-light .viewer-status{color:#506270;border-top:1px solid rgba(16,24,32,0.04)}

    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);font-weight:700}

    @media(max-width:880px){
      .top-center{order:3;width:100%;justify-content:flex-start;padding-top:8px}
      .top-right{order:2;margin-left:0}
      .viewer-top{flex-wrap:wrap;gap:8px}
    }
  </style>
    </head>
    <body>

        <main class="viewer" role="main" aria-label="Code viewer">

            <div class="viewer-top">
                <div class="top-left">
                    <button id="backBtn" class="btn btn-back" title="Back"><i
                            class="fa-solid fa-arrow-left"></i></button>
                    <div style="display:flex;flex-direction:column;min-width:0">
                        <div class="filename" id="fileTabName">loading.c</div>
                        <div class="subtle small" id="fileSub">Module 3 · C
                            file</div>
                    </div>
                </div>

                <div class="top-center" role="group"
                    aria-label="Primary file actions">
                    <button id="openRawBtn" class="tool-btn"
                        title="Open raw (new tab)"><i
                            class="fa-solid fa-link"></i> Raw</button>
                    <button id="downloadBtn" class="tool-btn"
                        title="Download file"><i
                            class="fa-solid fa-download"></i> Download</button>
                    <button id="copyFileBtn" class="tool-btn"
                        title="Copy entire file"><i
                            class="fa-solid fa-copy"></i> Copy</button>

                    <div
                        style="width:1px;height:28px;background:rgba(255,255,255,0.03);margin:0 8px;border-radius:2px"></div>

                    <button id="wrapBtn" class="tool-btn" title="Toggle wrap"><i
                            class="fa-solid fa-code-line"></i> Wrap</button>

                    <div
                        style="display:flex;align-items:center;gap:8px;margin-left:6px">
                        <label for="fontSize"
                            class="mb-0 small subtle">Font</label>
                        <input id="fontSize" type="range" min="12" max="20"
                            value="15" style="vertical-align:middle">
                    </div>
                </div>

                <div class="top-right">
                    <button id="themeToggle" class="tool-btn"
                        title="Toggle theme (Ctrl/Cmd+T)"><i
                            class="fa-solid fa-adjust"></i> Theme</button>
                    <button id="permLinkBtn" class="tool-btn"
                        title="Copy permalink for selection"><i
                            class="fa-solid fa-link"></i> Permalink</button>
                    <button id="moduleBtn" class="tool-btn primary"
                        title="Back to module"> <i
                            class="fa-solid fa-graduation-cap"></i> Module
                        3</button>
                </div>
            </div>

            <div class="viewer-editor position-relative">
                <div class="d-flex align-items-center mb-2">
                    <div class="pill me-2">C</div>
                    <div id="metaInfo" class="text-muted small">Fetching
                        file…</div>
                    <div class="ms-auto text-muted small"
                        id="statusMsg">Ready</div>
                </div>

                <div class="position-relative">
                    <pre id="codeBlock"
                        class="line-numbers language-c"><code id="code" class="language-c">/* Loading... */</code></pre>
                </div>

                <div id="hint" class="text-muted small mt-2">If fetching fails,
                    serve over <code>http</code> or <code>https</code> and
                    ensure the file path exists (GitHub Pages).</div>
            </div>

            <div class="viewer-status">
                <div>Filename: <strong id="statusFile">—</strong></div>
                <div class="d-flex gap-2 align-items-center">
                    <div id="sizeInfo" class="pill">—</div>
                    <div id="lineInfo" class="pill">— lines</div>
                </div>
            </div>
        </main>

        <!-- floating copy button + tooltip -->
        <button class="ln-copy-btn" id="lnCopyBtn" aria-hidden="true"
            title="Copy line"><i class="fa-solid fa-copy"></i></button>
        <div class="ln-tooltip" id="lnTooltip" aria-hidden="true"></div>

        <!-- Toast container -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index:12000">
            <div id="toastArea"></div>
        </div>

        <!-- Prism + plugin -->
        <script
            src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-c.min.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

        <!-- Bootstrap -->
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <script>
  (function(){
    // DOM refs
    const body = document.body;
    const backBtn = document.getElementById('backBtn');
    const fileTabName = document.getElementById('fileTabName');
    const fileSub = document.getElementById('fileSub');
    const statusFile = document.getElementById('statusFile');
    const metaInfo = document.getElementById('metaInfo');
    const sizeInfo = document.getElementById('sizeInfo');
    const lineInfo = document.getElementById('lineInfo');
    const statusMsg = document.getElementById('statusMsg');

    const openRawBtn = document.getElementById('openRawBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const copyFileBtn = document.getElementById('copyFileBtn');
    const wrapBtn = document.getElementById('wrapBtn');
    const fontSize = document.getElementById('fontSize');
    const themeToggle = document.getElementById('themeToggle');
    const permLinkBtn = document.getElementById('permLinkBtn');
    const moduleBtn = document.getElementById('moduleBtn');

    const codeEl = document.getElementById('code');
    const codeBlock = document.getElementById('codeBlock');
    const lnCopyBtn = document.getElementById('lnCopyBtn');
    const lnTooltip = document.getElementById('lnTooltip');
    const toastArea = document.getElementById('toastArea');

    const prismDark = document.getElementById('prism-dark');
    const prismLight = document.getElementById('prism-light');

    const THEME_KEY = 'viewer_theme_mode';

    // state
    let selStart = null, selEnd = null, safeFile = '';
    let attached = false;

    // fallback module detection
    const fallbackModule = (function(){
      const q = new URLSearchParams(location.search).get('file') || '';
      const m = q.match(/^(\d+)\./);
      return m ? `../module_${m[1]}.html` : '../module_3.html';
    })();

    backBtn.addEventListener('click', ()=> { if(history.length>1) history.back(); else location.href = fallbackModule; });
    moduleBtn.addEventListener('click', ()=> location.href = fallbackModule);

    // robust toast helper (ensures numeric delay)
    function toast(message, opts) {
      try {
        opts = opts || {};
        const type = typeof opts.type === 'string' ? opts.type : 'info';
        const delay = Number(opts.delay);
        const delaySafe = Number.isFinite(delay) ? delay : 1400;
        const classes = (type === 'success') ? 'bg-success text-white' :
                        (type === 'error')   ? 'bg-danger text-white'  :
                                               'bg-dark text-white';
        const el = document.createElement('div');
        el.className = `toast ${classes}`;
        el.setAttribute('role', 'status');
        el.setAttribute('aria-live', 'polite');
        el.setAttribute('aria-atomic', 'true');
        el.style.minWidth = '170px';
        el.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="toast-body" style="padding-right:0.5rem;">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;
        toastArea.appendChild(el);

        if (window.bootstrap && typeof bootstrap.Toast === 'function') {
          const bsToast = new bootstrap.Toast(el, { delay: delaySafe });
          bsToast.show();
          el.addEventListener('hidden.bs.toast', () => el.remove());
        } else {
          // fallback: remove after delay
          setTimeout(() => el.remove(), delaySafe);
        }
      } catch (err) {
        console.warn('toast helper failed:', err);
      }
    }

    // theme apply
    function applyTheme(mode){
      if(mode==='light'){ body.classList.add('viewer-light'); prismDark.disabled=true; prismLight.disabled=false; }
      else { body.classList.remove('viewer-light'); prismDark.disabled=false; prismLight.disabled=true; }
      localStorage.setItem(THEME_KEY, mode);
    }
    applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
    themeToggle.addEventListener('click', ()=> applyTheme(localStorage.getItem(THEME_KEY) === 'light' ? 'dark' : 'light'));
    window.addEventListener('keydown', (e)=> { if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='t'){ e.preventDefault(); themeToggle.click(); } });

    // helpers
    function getQuery(n){ return new URLSearchParams(location.search).get(n); }
    function setStatus(sizeText, lines){ sizeInfo.textContent = sizeText; lineInfo.textContent = (lines? lines + ' lines' : '— lines'); }

    // load file
    const fileParam = getQuery('file');
    if(!fileParam){
      fileTabName.textContent='No file specified'; statusFile.textContent='—';
      metaInfo.textContent='Open viewer.html?file=FILENAME.c'; codeEl.textContent='/* Use links like viewer.html?file=6.1.1.c */';
      try{ Prism.highlightElement(codeEl); }catch(e){}
      return;
    }

    safeFile = String(fileParam).replace(/(\.\.[\/\\])+/g,'').replace(/^\/+/,'');
    fileTabName.textContent = safeFile; statusFile.textContent = safeFile;
    fileSub.textContent = 'Module 3 · C file';
    metaInfo.textContent='Loading…'; statusMsg.textContent='Fetching…';
    const fileUrl = new URL(safeFile, location.href).href;

    fetch(fileUrl, {cache:'no-store'}).then(async res => {
      if(!res.ok) throw new Error('HTTP '+res.status+' — '+res.statusText);
      const contentLength = res.headers.get('Content-Length');
      const text = await res.text();

      codeEl.textContent = text;
      const sizeText = contentLength ? Math.round(contentLength/1024) + ' KB' : (text.length + ' bytes');
      metaInfo.textContent = `${sizeText} · ${new Date().toLocaleString()}`;
      setStatus(sizeText, text.split(/\r?\n/).length);
      statusMsg.textContent = 'Rendered';

      // actions
      openRawBtn.onclick = ()=> window.open(fileUrl,'_blank');
      downloadBtn.onclick = ()=> {
        const blob = new Blob([text], {type:'text/x-csrc'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = safeFile; document.body.appendChild(a); a.click(); a.remove();
      };
      copyFileBtn.onclick = async ()=> {
        try{ await navigator.clipboard.writeText(text); toast('File copied to clipboard', {type:'success'}); }
        catch(e){ toast('Copy failed', {type:'error'}); }
      };

      // highlight
      try{ if(window.Prism && typeof Prism.highlightElement === 'function') Prism.highlightElement(codeEl); } catch(e){ console.warn('Prism highlight error', e); }

      // attach line number handlers
      ensureLineNumbersThenAttach(text);
    }).catch(err => {
      console.error('[viewer] fetch error', err);
      metaInfo.textContent='Could not load file'; codeEl.textContent='/* Error: '+err.message+' */'; statusMsg.textContent='Error'; setStatus('—',null);
      if(err.message && err.message.includes('404')) document.getElementById('hint').textContent = 'File not found (404). Check path: '+fileUrl;
    });

    // wait for prism plugin to render line numbers, then attach handlers
    function ensureLineNumbersThenAttach(fullText){
      const maxWait = 1200; const start = Date.now();
      const check = () => {
        const ln = document.querySelector('.line-numbers .line-numbers-rows');
        if(ln){ attachLineNumberHandlers(fullText); applyHashHighlight(); return true; }
        return false;
      };
      if(check()) return;
      const ob = new MutationObserver((_, obs) => { if(check() || Date.now()-start>maxWait) obs.disconnect(); });
      ob.observe(codeBlock, {childList:true, subtree:true});
      setTimeout(()=> { try{ if(Prism.plugins && Prism.plugins.lineNumbers && Prism.plugins.lineNumbers.resize) Prism.plugins.lineNumbers.resize(codeBlock); }catch(e){} }, 40);
      setTimeout(()=> { if(!check()) attachLineNumberHandlers(fullText); }, 260);
    }

    function attachLineNumberHandlers(fullText){
      if(attached) return; attached = true;
      selStart = null; selEnd = null;

      const lines = fullText.replace(/\r/g,'').split('\n');
      const lnContainer = document.querySelector('.line-numbers .line-numbers-rows');
      if(!lnContainer) return;

      const copyBtn = lnCopyBtn;
      const tooltip = lnTooltip;
      copyBtn.classList.remove('show'); copyBtn.style.left='-9999px'; copyBtn.style.top='-9999px'; copyBtn.dataset.line = '';

      // small helper for tooltip near an element
      function showTooltip(el, message){
        tooltip.textContent = message;
        const r = el.getBoundingClientRect();
        tooltip.style.left = (r.right + window.scrollX + 8) + 'px';
        tooltip.style.top = (r.top + window.scrollY) + 'px';
        tooltip.classList.add('show');
        setTimeout(()=> tooltip.classList.remove('show'), 900);
      }

      const spans = Array.from(lnContainer.querySelectorAll('span'));
      spans.forEach((sp, idx) => {
        sp.setAttribute('role','button');
        sp.setAttribute('aria-label','Line '+(idx+1));
        sp.style.userSelect='none'; sp.style.cursor='pointer';

        sp.addEventListener('mouseenter', (ev)=>{
          const r = sp.getBoundingClientRect();
          copyBtn.style.left = (r.left + window.scrollX + r.width + 6) + 'px';
          copyBtn.style.top = (r.top + window.scrollY + (r.height/2) - 14) + 'px';
          copyBtn.dataset.line = idx;
          copyBtn.classList.add('show');
        });

        sp.addEventListener('mouseleave', (ev)=>{
          setTimeout(()=> {
            const over = document.querySelector('.ln-copy-btn:hover');
            if(!over) { copyBtn.classList.remove('show'); copyBtn.style.left='-9999px'; copyBtn.style.top='-9999px'; copyBtn.dataset.line=''; }
          }, 30);
        });

        // click -> copy single line; shift+click copies range (if selStart exists)
        sp.addEventListener('click', async (ev)=>{
          ev.preventDefault(); ev.stopPropagation();
          const lineno = idx;
          if(ev.shiftKey && selStart !== null){
            selEnd = lineno;
            highlightRange(selStart, selEnd);
            const a = Math.min(selStart, selEnd), b = Math.max(selStart, selEnd);
            const block = lines.slice(a, b+1).join('\n');
            try{ await navigator.clipboard.writeText(block); toast(`Copied lines ${a+1}-${b+1}`, {type:'success'}); } catch(e){ toast('Copy failed',{type:'error'}); }
          } else {
            // single-line copy
            selStart = lineno; selEnd = null;
            highlightRange(selStart, selStart);
            try{ await navigator.clipboard.writeText(lines[lineno]); toast(`Copied line ${lineno+1}`, {type:'success'}); } catch(e){ toast('Copy failed',{type:'error'}); }
            flashLine(lineno);
          }
        });
      });

      // hover copy button handler
      copyBtn.addEventListener('click', async (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
        const idx = parseInt(copyBtn.dataset.line, 10);
        if(isNaN(idx)) return;
        const lnText = lines[idx] !== undefined ? lines[idx] : '';
        try{ await navigator.clipboard.writeText(lnText); showTooltip(copyBtn, 'Copied'); toast(`Copied line ${idx+1}`, {type:'success'}); flashLine(idx); }
        catch(e){ showTooltip(copyBtn, 'Copy failed'); toast('Copy failed',{type:'error'}); }
      });

      // clicking outside clears selection overlays
      document.addEventListener('click', (ev)=>{
        const path = ev.composedPath ? ev.composedPath() : (ev.path || []);
        if(!path.includes(copyBtn) && !path.includes(lnContainer)) {
          document.querySelectorAll('.selected-overlay').forEach(e=>e.remove());
          selStart = selEnd = null;
        }
      });


    // highlightRange: position overlays using actual line-number spans (pixel-perfect)
    function highlightRange(a, b) {
        // remove any previous overlays
        document.querySelectorAll('.selected-overlay').forEach(e => e.remove());

        // ensure spans array is available
        const spanList = Array.from(lnContainer.querySelectorAll('span'));
        if (!spanList || spanList.length === 0) return;

        const codeRect = codeBlock.getBoundingClientRect();
        const pageLeft = codeRect.left + window.scrollX + 8; // small left padding matching pre
        const width = Math.max(codeRect.width - 24, 120);

        const start = Math.min(a, b);
        const end = Math.max(a, b);

        for (let i = start; i <= end; i++) {
            const span = spanList[i];
            if (!span) continue;
            const srect = span.getBoundingClientRect();
            const top = srect.top + window.scrollY;
            const height = Math.max(srect.height, 14);

            const ov = document.createElement('div');
            ov.className = 'selected-overlay';
            ov.style.top = (top) + 'px';
            ov.style.left = pageLeft + 'px';
            ov.style.width = width + 'px';
            ov.style.height = height + 'px';
            ov.style.borderRadius = '6px';
            document.body.appendChild(ov);
        }
    }
    // flash effect
    // flashLine: flash the specific line using span bounding rect
    function flashLine(lineIndex) {
        const spanList = Array.from(lnContainer.querySelectorAll('span'));
        const span = spanList[lineIndex];
        if (!span) return;

        const srect = span.getBoundingClientRect();
        const codeRect = codeBlock.getBoundingClientRect();
        const left = codeRect.left + window.scrollX + 8;
        const top = srect.top + window.scrollY;
        const width = Math.max(codeRect.width - 24, 120);
        const height = Math.max(srect.height, 14);

        const overlay = document.createElement('div');
        overlay.className = 'ln-flash';
        overlay.style.left = left + 'px';
        overlay.style.top = top + 'px';
        overlay.style.width = width + 'px';
        overlay.style.height = height + 'px';
        overlay.style.background = body.classList.contains('viewer-light') ? 'rgba(163,190,140,0.22)' : 'rgba(163,190,140,0.18)';
        overlay.style.borderRadius = '6px';
        overlay.style.pointerEvents = 'none';
        overlay.style.zIndex = 9997;
        document.body.appendChild(overlay);
        setTimeout(() => {
            overlay.style.transition = 'opacity .35s ease';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 380);
        }, 360);
    }

      // Permalink click: copy permalink for current selection; if none, fallback to hovered line
      permLinkBtn.addEventListener('click', async ()=>{
        let a = selStart;
        let b = selEnd;

        // fallback to hovered line if no selection
        const hoveredIdx = copyBtn.dataset.line !== '' ? Number(copyBtn.dataset.line) : null;
        if(a === null && hoveredIdx !== null) a = b = hoveredIdx;

        if(a === null){
          toast('Click a line number first', {type:'error'});
          return;
        }

        const start = Math.min(a, b ?? a);
        const end = Math.max(a, b ?? a);
        const base = location.origin + location.pathname + '?file=' + encodeURIComponent(safeFile);
        const hash = (start===end) ? `#L${start+1}` : `#L${start+1}-L${end+1}`;
        const url = base + hash;
        try{ await navigator.clipboard.writeText(url); toast('Permalink copied', {type:'success'}); } catch(e){ toast('Permalink copy failed', {type:'error'}); }
      });

      // apply a hash highlight if page loaded with a fragment
      function applyHash(){
  const h = location.hash;
  if(!h) return;
  const m = h.match(/^#L(\d+)(?:-L(\d+))?/i);
  if(!m) return;
  const a = parseInt(m[1],10)-1;
  const b = m[2] ? parseInt(m[2],10)-1 : a;

  const spanList = Array.from(lnContainer.querySelectorAll('span'));
  const firstSpan = spanList[a];
  if(firstSpan){
    // Scroll the span into view (centered) and then highlight exactly
    firstSpan.scrollIntoView({ block: 'center', inline: 'nearest', behavior: 'auto' });
    // small delay to ensure layout stabilizes after scrolling
    setTimeout(()=> {
      selStart = a; selEnd = b;
      highlightRange(a,b);
      toast(`Highlighted ${a+1}${a!==b?'-'+(b+1):''}`, {type:'success', delay:1200});
    }, 40);
  } else {
    // fallback to previous behavior if span not found
    selStart = a; selEnd = b;
    highlightRange(a,b);
    toast(`Highlighted ${a+1}${a!==b?'-'+(b+1):''}`, {type:'success', delay:1200});
  }
}

      window._applyHashHighlight = applyHash;
    }

    function applyHashHighlight(){
      if(typeof window._applyHashHighlight === 'function') window._applyHashHighlight();
    }
    // ensure hashchange also triggers highlight
    window.addEventListener('hashchange', ()=> { applyHashHighlight(); });

    // wrap toggle
    let wrapped = false;
    wrapBtn.addEventListener('click', ()=> {
      wrapped = !wrapped;
      if(wrapped){ codeBlock.style.whiteSpace='pre-wrap'; codeBlock.style.wordBreak='break-word'; wrapBtn.classList.add('active'); }
      else { codeBlock.style.whiteSpace=''; codeBlock.style.wordBreak=''; wrapBtn.classList.remove('active'); }
    });

    // font slider
    fontSize.addEventListener('input', (e)=> { document.querySelectorAll('pre[class*="language-"]').forEach(p => p.style.fontSize = e.target.value + 'px'); });

    // init prism theme links
    (function initPrismLinks(){ const saved = localStorage.getItem(THEME_KEY) || 'dark'; if(saved==='light'){ prismDark.disabled=true; prismLight.disabled=false; } else { prismDark.disabled=false; prismLight.disabled=true; } })();

  })();
  </script>
    </body>
</html>
